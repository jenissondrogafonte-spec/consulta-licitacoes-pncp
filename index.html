<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNCP Analytics - Painel Geral</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #004494; 
            --success: #198754; 
            --danger: #dc3545; 
            --warning: #f1c40f; 
            --bg: #f0f2f5; 
        }

        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; color: #34495e; }

        /* Navbar Moderna */
        .navbar-custom { 
            background: linear-gradient(135deg, #004494 0%, #002a5c 100%); 
            padding: 1.5rem 0 3.5rem; 
            color: white; 
            border-radius: 0 0 35px 35px; 
        }

        .hover-opacity-100:hover {
            opacity: 1 !important;
            text-decoration: underline !important;
        }

        /* Filtros */
        .filter-container { 
            background: white; 
            margin-top: -45px; 
            border-radius: 20px; 
            padding: 25px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.08); 
            border: 1px solid rgba(255,255,255,0.3);
        }

        .form-label { font-size: 0.7rem; font-weight: 800; color: #95a5a6; text-transform: uppercase; letter-spacing: 0.5px; }
        .form-control { border-radius: 12px; border: 1px solid #e9ecef; padding: 10px 15px; font-size: 0.9rem; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,68,148,0.1); }

        /* Cards */
        .edital-card { 
            background: white; 
            border-radius: 20px; 
            border: none; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            height: 100%; 
            display: flex;
            flex-direction: column;
            border: 1px solid #f1f3f5;
        }

        .edital-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); border-color: var(--primary); }

        .card-header-custom { 
            padding: 15px 20px; 
            border-bottom: 1px solid #f8f9fa; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .badge-data { background: #eef2f7; color: var(--primary); font-weight: 700; border-radius: 10px; padding: 6px 12px; font-size: 0.75rem; }
        .valor-destaque { color: var(--success); font-weight: 800; font-size: 1.3rem; letter-spacing: -0.5px; }
        .label-small { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: #95a5a6; }

        /* Modal */
        .modal-content { border-radius: 25px; border: none; overflow: hidden; }
        .modal-header { border: none; padding: 20px 30px; }
    </style>
</head>
<body>

<div class="navbar-custom shadow-sm">
    <div class="container-fluid px-5">
        <div class="row align-items-center">
            <div class="col-md-5">
                <h2 class="fw-bold mb-0">
                    <i class="fas fa-chart-network me-2"></i>PNCP <span class="fw-light">Analytics</span>
                </h2>
                <div class="mt-2">
                    <a href="consulta_empresa.html" class="text-white text-decoration-none small opacity-75 hover-opacity-100">
                        <i class="fas fa-arrow-right me-1"></i> Ir para Consulta por Empresa (CNPJ 08.778.201)
                    </a>
                </div>
            </div>
            <div class="col-md-7 text-end">
                <div class="d-inline-block text-start me-4">
                    <div class="label-small text-white opacity-75">Volume Filtrado</div>
                    <h4 class="mb-0 fw-bold" id="dash-total">R$ 0,00</h4>
                </div>
                <span class="badge bg-white text-primary rounded-pill px-4 py-2 fw-bold shadow-sm" id="contador">Carregando...</span>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid px-5 mb-5">
    <div class="filter-container mb-5">
        <div class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label">Órgão / UASG</label>
                <input type="text" id="fOrgao" class="form-control" placeholder="Ex: Exercito" oninput="debounceFiltrar()">
            </div>
            <div class="col-md-2">
                <label class="form-label">Fornecedor / CNPJ</label>
                <input type="text" id="fForn" class="form-control" placeholder="Buscar empresa..." oninput="debounceFiltrar()">
            </div>
            <div class="col-md-1">
                <label class="form-label">Edital</label>
                <input type="text" id="fEdital" class="form-control" placeholder="00/2025" oninput="debounceFiltrar()">
            </div>
            <div class="col-md-1">
                <label class="form-label">UF</label>
                <input type="text" id="fUF" class="form-control" placeholder="MG" maxlength="2" oninput="debounceFiltrar()">
            </div>
            <div class="col-md-2">
                <label class="form-label">Data Início</label>
                <input type="date" id="fDataIni" class="form-control" onchange="filtrar()">
            </div>
            <div class="col-md-2">
                <label class="form-label">Data Fim</label>
                <input type="date" id="fDataFim" class="form-control" onchange="filtrar()">
            </div>
            <div class="col-md-2">
                <button class="btn btn-light border w-100 py-2 fw-bold text-muted" onclick="limpar()"><i class="fas fa-sync me-2"></i>Limpar</button>
            </div>
        </div>
    </div>

    <div id="lista" class="row g-4">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Carregando base de dados...</p>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold"><i class="fas fa-list-check me-2"></i>Itens e Ganhadores</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0 bg-light" id="corpoModal"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let dadosOriginal = [];

    async function carregar() {
        try {
            const r = await fetch('dados.json?v=' + Date.now());
            dadosOriginal = await r.json();
            filtrar();
        } catch(e) {
            document.getElementById('lista').innerHTML = `<div class="alert alert-danger">Erro: Certifique-se que o dados.json existe.</div>`;
        }
    }

    function renderizar(lista) {
        const container = document.getElementById('lista');
        if (lista.length === 0) {
            container.innerHTML = `<div class="col-12 text-center py-5 text-muted"><h5>Nenhuma licitação encontrada.</h5></div>`;
            return;
        }

        const grupos = {};
        let totalFinanceiro = 0;

        // Agrupamento por Licitação (UASG + Edital)
        lista.forEach(item => {
            const chave = item.Licitacao;
            if (!grupos[chave]) {
                grupos[chave] = { 
                    ...item, 
                    ValorTotalEdital: 0, 
                    Empresas: new Set() 
                };
            }
            grupos[chave].Empresas.add(item.Fornecedor);
            
            // Soma apenas itens que venceram
            item.Itens.forEach(it => {
                if (it.Status === "Venceu") {
                    grupos[chave].ValorTotalEdital += (it.Total || 0);
                }
            });
        });

        const html = Object.values(grupos).sort((a,b) => new Date(b.DataResult) - new Date(a.DataResult)).map(g => {
            totalFinanceiro += g.ValorTotalEdital;
            const statusLabel = g.ValorTotalEdital > 0 ? 'HOMOLOGADO' : 'EM ABERTO';
            const statusClass = g.ValorTotalEdital > 0 ? 'text-success' : 'text-warning';

            return `
            <div class="col-md-6 col-lg-4">
                <div class="edital-card shadow-sm">
                    <div class="card-header-custom">
                        <span class="badge-data">${g.DataResult.split('T')[0]}</span>
                        <span class="label-small fw-800 ${statusClass}">${statusLabel}</span>
                    </div>
                    <div class="p-4 flex-grow-1">
                        <div class="label-small mb-1">${g.Municipio} - ${g.UF}</div>
                        <h6 class="fw-bold text-primary mb-3 line-clamp-2" style="height: 2.8rem; overflow: hidden;">${g.Orgao}</h6>
                        
                        <div class="d-flex justify-content-between align-items-end mt-2">
                            <div>
                                <div class="label-small">Total do Edital</div>
                                <div class="valor-destaque">R$ ${g.ValorTotalEdital.toLocaleString('pt-BR', {minimumFractionDigits:2})}</div>
                            </div>
                            <div class="text-end">
                                <div class="label-small">Edital</div>
                                <div class="fw-bold small">${g.Edital}</div>
                            </div>
                        </div>
                    </div>
                    <div class="px-4 pb-4 pt-0 d-flex gap-2">
                        <button class="btn btn-primary w-100 rounded-pill fw-bold btn-sm py-2" onclick="verItens('${g.Licitacao}')">
                            <i class="fas fa-search me-1"></i> Detalhes
                        </button>
                        <a href="${g.Link}" target="_blank" class="btn btn-outline-primary rounded-circle btn-sm p-2" style="width:36px; height:36px">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                </div>
            </div>`;
        }).join('');

        container.innerHTML = html;
        document.getElementById('dash-total').innerText = totalFinanceiro.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        document.getElementById('contador').innerText = Object.keys(grupos).length + " Editais Encontrados";
    }

    function verItens(idLic) {
        // Busca todos os registros (fornecedores) vinculados a esta licitação
        const registros = dadosOriginal.filter(x => x.Licitacao === idLic);
        const lic = registros[0];
        const corpo = document.getElementById('corpoModal');

        let tabelaHtml = '';
        registros.forEach(reg => {
            tabelaHtml += `
                <div class="p-3 bg-white border-bottom mt-3">
                    <span class="badge bg-primary mb-2">${reg.CNPJ}</span>
                    <h6 class="fw-bold mb-0">${reg.Fornecedor}</h6>
                </div>
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                        <tr><th class="ps-3">Item</th><th>Descrição</th><th class="text-end pe-3">Valor Total</th></tr>
                    </thead>
                    <tbody>
                        ${reg.Itens.map(it => `
                            <tr>
                                <td class="ps-3 fw-bold">${it.Item}</td>
                                <td class="small">${it.Desc}</td>
                                <td class="text-end pe-3 fw-bold ${it.Status === 'Venceu' ? 'text-success' : 'text-muted'}">
                                    R$ ${it.Total.toLocaleString('pt-BR', {minimumFractionDigits:2})}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        });

        corpo.innerHTML = `
            <div class="p-4 bg-white border-bottom shadow-sm">
                <div class="label-small">Órgão Comprador</div>
                <h5 class="fw-bold text-primary mb-1">${lic.Orgao}</h5>
                <div class="small text-muted">UASG: ${lic.UASG} | Edital: ${lic.Edital}</div>
            </div>
            <div class="p-0">${tabelaHtml}</div>`;
        
        new bootstrap.Modal(document.getElementById('modalDetalhes')).show();
    }

    function filtrar() {
        const q = {
            o: document.getElementById('fOrgao').value.toLowerCase(),
            f: document.getElementById('fForn').value.toLowerCase(),
            e: document.getElementById('fEdital').value,
            uf: document.getElementById('fUF').value.toUpperCase(),
            di: document.getElementById('fDataIni').value,
            df: document.getElementById('fDataFim').value
        };

        const res = dadosOriginal.filter(i => {
            const d = i.DataResult.split('T')[0];
            return (!q.o || i.Orgao.toLowerCase().includes(q.o) || i.UASG.includes(q.o)) &&
                   (!q.f || i.Fornecedor.toLowerCase().includes(q.f) || i.CNPJ.includes(q.f)) &&
                   (!q.e || i.Edital.includes(q.e)) &&
                   (!q.uf || i.UF === q.uf) &&
                   (!q.di || d >= q.di) && (!q.df || d <= q.df);
        });
        renderizar(res);
    }

    function debounceFiltrar() { clearTimeout(window.t); window.t = setTimeout(filtrar, 300); }
    function limpar() { document.querySelectorAll('input').forEach(i => i.value = ''); filtrar(); }
    
    carregar();
</script>
</body>
</html>
