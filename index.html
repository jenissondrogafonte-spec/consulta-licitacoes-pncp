<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor PNCP - Pesquisa Avan√ßada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .filtro-box { background-color: #e9ecef; border-radius: 8px; padding: 15px; }
        .table-hover tbody tr:hover { background-color: #f1f1f1; }
    </style>
</head>
<body class="bg-light p-4">
    <div class="container bg-white p-4 rounded shadow">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-primary mb-0">üîç Monitor de Licita√ß√µes</h2>
            <span class="badge bg-success" id="contadorRegistros">Carregando...</span>
        </div>

        <div class="filtro-box mb-4">
            <h5 class="mb-3 text-secondary">Filtros de Pesquisa</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Fornecedor / CNPJ</label>
                    <input type="text" id="buscaFornecedor" class="form-control" placeholder="Ex: Drogafonte...">
                </div>
                
                <div class="col-md-3">
                    <label class="form-label fw-bold">√ìrg√£o / UASG</label>
                    <input type="text" id="buscaOrgao" class="form-control" placeholder="Ex: 153055...">
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-bold">N¬∫ Licita√ß√£o</label>
                    <input type="text" id="buscaLicitacao" class="form-control" placeholder="Ex: 90001/2024">
                </div>

                <div class="col-md-3">
                    <label class="form-label fw-bold">N¬∫ Processo</label>
                    <input type="text" id="buscaProcesso" class="form-control" placeholder="Ex: 23000...">
                </div>
            </div>
            
            <div class="text-end mt-3">
                <button class="btn btn-outline-secondary btn-sm" onclick="limparFiltros()">üßπ Limpar Filtros</button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Data</th>
                        <th>√ìrg√£o (UASG)</th>
                        <th>Licita√ß√£o / Processo</th>
                        <th>Fornecedor</th>
                        <th>Total (R$)</th>
                    </tr>
                </thead>
                <tbody id="tabelaDados"></tbody>
            </table>
            <p id="statusMsg" class="text-center text-muted mt-2">Carregando dados...</p>
        </div>
    </div>

    <script>
        let dadosGlobais = []; // Guarda os dados na mem√≥ria

        fetch('dados.json')
            .then(r => r.json())
            .then(data => {
                dadosGlobais = data.reverse(); // Salva e inverte (mais novos primeiro)
                document.getElementById('statusMsg').style.display = 'none';
                render(dadosGlobais);
                atualizarContador(dadosGlobais.length);

                // Adiciona o "Ouvido" em cada campo de digita√ß√£o
                ['buscaFornecedor', 'buscaOrgao', 'buscaLicitacao', 'buscaProcesso'].forEach(id => {
                    document.getElementById(id).addEventListener('keyup', filtrarDados);
                });
            })
            .catch(e => document.getElementById('statusMsg').innerHTML = `<span class="text-danger">Erro: ${e.message}</span>`);

        // Fun√ß√£o que desenha a tabela
        function render(lista) {
            const tbody = document.getElementById('tabelaDados');
            tbody.innerHTML = '';
            
            if(lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted p-4">Nenhum resultado encontrado para esses filtros.</td></tr>';
                return;
            }

            // Mostra no m√°ximo 500 itens para n√£o travar o navegador se tiver muita coisa
            lista.slice(0, 500).forEach(i => {
                const processo = i.Num_Processo ? `<div class="text-muted small">Proc: ${i.Num_Processo}</div>` : '';
                
                tbody.innerHTML += `<tr>
                    <td>${i.Data_Homologacao}</td>
                    <td><small>${i.Orgao_Codigo}</small></td>
                    <td>
                        <strong>${i.Num_Licitacao}</strong>
                        ${processo}
                    </td>
                    <td>
                        ${i.Fornecedor}
                        <div class="small text-secondary">${i.CNPJ_Fornecedor || ''}</div>
                    </td>
                    <td class="text-success fw-bold text-nowrap">R$ ${i['Total_Ganho_R$'].toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                </tr>`;
            });
            atualizarContador(lista.length);
        }

        // A M√°gica da Filtragem Individual
        function filtrarDados() {
            // 1. Pega o valor de cada campo e converte para min√∫sculo
            const fFornecedor = document.getElementById('buscaFornecedor').value.toLowerCase();
            const fOrgao = document.getElementById('buscaOrgao').value.toLowerCase();
            const fLicitacao = document.getElementById('buscaLicitacao').value.toLowerCase();
            const fProcesso = document.getElementById('buscaProcesso').value.toLowerCase();

            // 2. Filtra os dados globais
            const filtrados = dadosGlobais.filter(item => {
                // Verifica cada campo (se estiver vazio, ignora aquele filtro)
                const matchForn = !fFornecedor || (item.Fornecedor && item.Fornecedor.toLowerCase().includes(fFornecedor)) || (item.CNPJ_Fornecedor && item.CNPJ_Fornecedor.includes(fFornecedor));
                const matchOrgao = !fOrgao || (item.Orgao_Codigo && item.Orgao_Codigo.toLowerCase().includes(fOrgao));
                const matchLic = !fLicitacao || (item.Num_Licitacao && item.Num_Licitacao.toLowerCase().includes(fLicitacao));
                const matchProc = !fProcesso || (item.Num_Processo && item.Num_Processo.toLowerCase().includes(fProcesso));

                // S√ì PASSA SE ATENDER A TODAS AS CONDI√á√ïES (L√≥gica E)
                return matchForn && matchOrgao && matchLic && matchProc;
            });

            render(filtrados);
        }

        function limparFiltros() {
            document.getElementById('buscaFornecedor').value = '';
            document.getElementById('buscaOrgao').value = '';
            document.getElementById('buscaLicitacao').value = '';
            document.getElementById('buscaProcesso').value = '';
            render(dadosGlobais);
        }

        function atualizarContador(qtd) {
            document.getElementById('contadorRegistros').innerText = `${qtd} registros`;
        }
    </script>
</body>
</html>
