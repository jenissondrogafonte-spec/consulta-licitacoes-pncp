<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Licita√ß√µes PNCP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; }
        .table-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .filter-label { font-weight: bold; font-size: 0.9rem; color: #495057; }
        .font-table { font-size: 0.85rem; }
    </style>
</head>
<body class="p-4">
    <div class="container-fluid table-container">
        <h2 class="text-primary mb-4 border-bottom pb-2">üîç Monitor de Preg√µes PNCP</h2>
        
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <label class="filter-label">Fornecedor / CNPJ</label>
                <input type="text" id="fForn" class="form-control" placeholder="Buscar empresa...">
            </div>
            <div class="col-md-3">
                <label class="filter-label">Nome do √ìrg√£o</label>
                <input type="text" id="fOrg" class="form-control" placeholder="Ex: Minist√©rio da Sa√∫de">
            </div>
            <div class="col-md-3">
                <label class="filter-label">C√≥d. UASG</label>
                <input type="text" id="fUasg" class="form-control" placeholder="Ex: 90140">
            </div>
            <div class="col-md-3">
                <label class="filter-label">N¬∫ Licita√ß√£o (ComprasNet)</label>
                <input type="text" id="fLic" class="form-control" placeholder="Ex: 901402025">
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover table-bordered table-sm align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Data</th>
                        <th>UASG</th>
                        <th>√ìrg√£o Entidade</th>
                        <th>Licita√ß√£o (Padr√£o ComprasNet)</th>
                        <th>Fornecedor Vencedor</th>
                        <th>Itens</th>
                        <th>Valor Total</th>
                    </tr>
                </thead>
                <tbody id="tabelaDados" class="font-table">
                    </tbody>
            </table>
            <div id="loading" class="text-center p-5 text-muted">Carregando dados do servidor...</div>
        </div>
    </div>

    <script>
        // Anti-cache na URL do JSON
        const urlJSON = 'dados.json?v=' + new Date().getTime();

        fetch(urlJSON)
            .then(r => r.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                window.baseDados = data.reverse(); 
                render(window.baseDados);

                // Ativar filtros
                ['fForn', 'fOrg', 'fUasg', 'fLic'].forEach(id => {
                    document.getElementById(id).addEventListener('input', filtrar);
                });
            })
            .catch(err => {
                document.getElementById('loading').innerHTML = "‚ùå Erro ao carregar dados ou arquivo inexistente.";
            });

        function render(lista) {
            const body = document.getElementById('tabelaDados');
            body.innerHTML = lista.map(item => `
                <tr>
                    <td>${formatData(item.Data)}</td>
                    <td class="text-secondary fw-bold">${item.UASG || ''}</td>
                    <td>${item.Orgao || ''}</td>
                    <td class="text-primary fw-bold">${item.Licitacao || ''}</td>
                    <td><b>${item.Fornecedor || ''}</b><br><small class="text-muted">${item.CNPJ || ''}</small></td>
                    <td class="text-center">${item.Itens || '0'}</td>
                    <td class="text-success fw-bold text-nowrap">R$ ${Number(item.Total).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                </tr>
            `).join('');
        }

        function filtrar() {
            const vForn = document.getElementById('fForn').value.toLowerCase();
            const vOrg = document.getElementById('fOrg').value.toLowerCase();
            const vUasg = document.getElementById('fUasg').value.toLowerCase();
            const vLic = document.getElementById('fLic').value.toLowerCase();

            const filtrados = window.baseDados.filter(i => {
                return ( (i.Fornecedor || '').toLowerCase().includes(vForn) || (i.CNPJ || '').includes(vForn) ) &&
                       ( (i.Orgao || '').toLowerCase().includes(vOrg) ) &&
                       ( (i.UASG || '').includes(vUasg) ) &&
                       ( (i.Licitacao || '').includes(vLic) );
            });
            render(filtrados);
        }

        function formatData(s) {
            if (!s || s.length !== 8) return s;
            return s.slice(6,8) + '/' + s.slice(4,6) + '/' + s.slice(0,4);
        }
    </script>
</body>
</html>
