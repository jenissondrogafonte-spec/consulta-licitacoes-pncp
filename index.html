<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Licita√ß√µes PNCP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: sans-serif; }
        .container-main { background: white; border-radius: 8px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .filter-title { font-size: 0.85rem; font-weight: bold; color: #6c757d; text-transform: uppercase; }
        .table-custom { font-size: 0.85rem; }
    </style>
</head>
<body class="p-4">
    <div class="container-fluid container-main">
        <h3 class="text-primary mb-4">üîç Painel de Preg√µes (Padr√£o ComprasNet)</h3>
        
        <div class="row g-3 mb-4 border-bottom pb-4">
            <div class="col-md-3">
                <label class="filter-title">Fornecedor / CNPJ</label>
                <input type="text" id="filtroEmpresa" class="form-control" placeholder="Ex: Nome da Empresa">
            </div>
            <div class="col-md-3">
                <label class="filter-title">Nome do √ìrg√£o</label>
                <input type="text" id="filtroOrgao" class="form-control" placeholder="Ex: Secretaria de Sa√∫de">
            </div>
            <div class="col-md-3">
                <label class="filter-title">C√≥d. UASG</label>
                <input type="text" id="filtroUasg" class="form-control" placeholder="Digite a UASG">
            </div>
            <div class="col-md-3">
                <label class="filter-title">Licita√ß√£o (UASG+N¬∫+Ano)</label>
                <input type="text" id="filtroLic" class="form-control" placeholder="Ex: 926150901402025">
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover table-bordered table-custom">
                <thead class="table-dark">
                    <tr>
                        <th>Data</th>
                        <th>C√≥d. UASG</th>
                        <th>√ìrg√£o Entidade</th>
                        <th>Licita√ß√£o (ComprasNet)</th>
                        <th>Fornecedor</th>
                        <th class="text-center">Itens</th>
                        <th>Valor Total</th>
                    </tr>
                </thead>
                <tbody id="listaDados">
                </tbody>
            </table>
            <div id="loader" class="text-center p-4 text-muted">Buscando informa√ß√µes...</div>
        </div>
    </div>

    <script>
        const endpoint = 'dados.json?v=' + Date.now();

        fetch(endpoint)
            .then(res => res.json())
            .then(data => {
                document.getElementById('loader').style.display = 'none';
                window.dadosOriginais = data.reverse(); 
                atualizarTabela(window.dadosOriginais);

                // Ativando os 4 filtros
                ['filtroEmpresa', 'filtroOrgao', 'filtroUasg', 'filtroLic'].forEach(id => {
                    document.getElementById(id).addEventListener('input', filtrar);
                });
            })
            .catch(() => {
                document.getElementById('loader').innerHTML = "‚ö†Ô∏è O arquivo de dados ainda n√£o foi gerado pelo rob√¥.";
            });

        function atualizarTabela(lista) {
            const tbody = document.getElementById('listaDados');
            tbody.innerHTML = lista.map(item => `
                <tr>
                    <td>${formatarData(item.Data)}</td>
                    <td class="fw-bold">${item.UASG || ''}</td>
                    <td>${item.Orgao || ''}</td>
                    <td class="text-primary fw-bold">${item.Licitacao || ''}</td>
                    <td><b>${item.Fornecedor || ''}</b><br><small class="text-muted">${item.CNPJ || ''}</small></td>
                    <td class="text-center">${item.Itens || '0'}</td>
                    <td class="text-success fw-bold">R$ ${Number(item.Total).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                </tr>
            `).join('');
        }

        function filtrar() {
            const fEmp = document.getElementById('filtroEmpresa').value.toLowerCase();
            const fOrg = document.getElementById('filtroOrgao').value.toLowerCase();
            const fUasg = document.getElementById('filtroUasg').value.toLowerCase();
            const fLic = document.getElementById('filtroLic').value.toLowerCase();

            const filtrados = window.dadosOriginais.filter(i => {
                return ( (i.Fornecedor || '').toLowerCase().includes(fEmp) || (i.CNPJ || '').includes(fEmp) ) &&
                       ( (i.Orgao || '').toLowerCase().includes(fOrg) ) &&
                       ( (i.UASG || '').includes(fUasg) ) &&
                       ( (i.Licitacao || '').includes(fLic) );
            });
            atualizarTabela(filtrados);
        }

        function formatarData(d) {
            if (!d || d.length !== 8) return d;
            return d.slice(6,8) + '/' + d.slice(4,6) + '/' + d.slice(0,4);
        }
    </script>
</body>
</html>
