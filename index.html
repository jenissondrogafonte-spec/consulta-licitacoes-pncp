<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel PNCP Dinâmico</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #004494; --success: #198754; --danger: #dc3545; --warning: #ffc107; }
        body { background: #f4f7fa; font-family: 'Plus Jakarta Sans', sans-serif; color: #2d3436; }
        
        /* Navbar com gradiente suave */
        .navbar-custom { background: linear-gradient(135deg, #004494 0%, #003370 100%); color: white; padding: 1.5rem 0; border-radius: 0 0 25px 25px; }
        
        /* Cards de Estatísticas */
        .dash-card { background: white; border-radius: 18px; padding: 1.5rem; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.04); transition: transform 0.2s; }
        .dash-card:hover { transform: translateY(-3px); }
        
        /* Caixa de Filtros Flutuante */
        .filter-box { background: white; border-radius: 20px; padding: 25px; margin-top: -40px; box-shadow: 0 15px 35px rgba(0,0,0,0.08); }
        
        /* Cards de Resultado */
        .res-card { 
            background: white; border-radius: 20px; border: 1px solid rgba(0,0,0,0.04); 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
            height: 100%; display: flex; flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .res-card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); border-color: var(--primary); }
        .res-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--success); }
        
        /* Elementos UI */
        .progress { height: 6px; border-radius: 10px; background: #e9ecef; margin: 12px 0; }
        .progress-bar-hml { background: var(--success); }
        
        .valor-total { font-size: 1.3rem; font-weight: 800; color: var(--success); letter-spacing: -0.5px; }
        .label-small { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; color: #95a5a6; letter-spacing: 0.5px; margin-bottom: 4px; display: block; }
        
        .form-control { border-radius: 8px; border: 1px solid #dfe6e9; font-size: 0.9rem; padding: 8px 12px; }
        .form-control:focus { box-shadow: 0 0 0 3px rgba(0,68,148,0.1); border-color: var(--primary); }
        
        .btn-buscar { background-color: var(--primary); color: white; font-weight: 600; border-radius: 8px; }
        .btn-buscar:hover { background-color: #003370; color: white; }
        .btn-limpar { background-color: #f1f2f6; color: #636e72; font-weight: 600; border-radius: 8px; }
        .btn-limpar:hover { background-color: #dfe6e9; color: #2d3436; }
    </style>
</head>
<body>

<div class="navbar-custom shadow-lg">
    <div class="container-fluid px-5">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2 class="fw-bold mb-0"><i class="fas fa-chart-network me-2"></i>PNCP <span class="fw-light">Analytics</span></h2>
                <p class="small opacity-75 mb-0">Monitorização Inteligente de Licitações</p>
            </div>
            <div class="col-md-6 text-end">
                <div class="d-inline-block text-start me-4">
                    <div class="label-small text-white opacity-75" style="color: white !important;">Volume Filtrado</div>
                    <h4 class="mb-0 fw-bold" id="dash-valor-total">R$ 0,00</h4>
                </div>
                <span class="badge bg-white text-primary rounded-pill px-4 py-2 fw-bold shadow-sm" id="contador">Carregando...</span>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid px-5">
    <div class="filter-box mb-5">
        <div class="row g-3 align-items-end">
            <div class="col-md-1"><label class="label-small">UASG</label><input type="text" id="fUasg" class="form-control" placeholder="Ex: 123" oninput="debounceFiltrar()"></div>
            <div class="col-md-1"><label class="label-small">Edital</label><input type="text" id="fEdital" class="form-control" placeholder="10/2025" oninput="debounceFiltrar()"></div>
            <div class="col-md-1"><label class="label-small">UF</label><input type="text" id="fUF" class="form-control" placeholder="PE" maxlength="2" oninput="debounceFiltrar()"></div>
            <div class="col-md-2"><label class="label-small">Município</label><input type="text" id="fMuni" class="form-control" placeholder="Caruaru" oninput="debounceFiltrar()"></div>
            <div class="col-md-3"><label class="label-small">Fornecedor / CNPJ</label><input type="text" id="fForn" class="form-control" placeholder="Nome ou CNPJ" oninput="debounceFiltrar()"></div>
            <div class="col-md-1"><label class="label-small">Início</label><input type="date" id="fDataIni" class="form-control" onchange="filtrar()"></div>
            <div class="col-md-1"><label class="label-small">Fim</label><input type="date" id="fDataFim" class="form-control" onchange="filtrar()"></div>
            
            <div class="col-md-2">
                <div class="d-flex gap-2">
                    <button class="btn btn-buscar w-100" onclick="filtrar()"><i class="fas fa-search me-1"></i> Buscar</button>
                    <button class="btn btn-limpar w-50" onclick="limpar()" title="Limpar Filtros"><i class="fas fa-eraser"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="dash-card d-flex align-items-center justify-content-between">
                <div>
                    <div class="label-small text-success">Homologados</div>
                    <h3 class="fw-bold mb-0 text-success" id="stat-hml">0</h3>
                </div>
                <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success"><i class="fas fa-check"></i></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dash-card d-flex align-items-center justify-content-between">
                <div>
                    <div class="label-small text-danger">Fracassados</div>
                    <h3 class="fw-bold mb-0 text-danger" id="stat-frc">0</h3>
                </div>
                <div class="bg-danger bg-opacity-10 p-3 rounded-circle text-danger"><i class="fas fa-times"></i></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dash-card d-flex align-items-center justify-content-between">
                <div>
                    <div class="label-small text-warning">Desertos</div>
                    <h3 class="fw-bold mb-0 text-warning" id="stat-dst">0</h3>
                </div>
                <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning"><i class="fas fa-exclamation-triangle"></i></div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="dash-card d-flex align-items-center justify-content-between" style="background: #004494; color: white;">
                <div>
                    <div class="label-small text-white opacity-75">Contratos Listados</div>
                    <h3 class="fw-bold mb-0" id="stat-qtd">0</h3>
                </div>
                <div class="bg-white bg-opacity-25 p-3 rounded-circle"><i class="fas fa-file-contract"></i></div>
            </div>
        </div>
    </div>

    <div id="lista" class="row g-4 mb-5">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted fw-bold">A carregar dados...</p>
        </div>
    </div>
</div>

<div class="modal fade" id="modalItens" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 25px; overflow: hidden;">
            <div class="modal-header bg-primary text-white p-4">
                <h5 class="modal-title fw-bold"><i class="fas fa-list-ul me-2"></i> Detalhamento dos Itens</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="infoLicitacao" class="px-4 py-3 bg-light border-bottom"></div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-dark text-white">
                            <tr>
                                <th class="ps-4 py-3">Item</th>
                                <th class="py-3">Descrição</th>
                                <th class="py-3">Qtd</th>
                                <th class="py-3">Unitário</th>
                                <th class="py-3 pe-4 text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody id="corpoModal"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let dadosOriginal = [];
    let timeoutBusca = null;

    async function carregar() {
        try {
            const r = await fetch('dados.json?v=' + Date.now());
            if (!r.ok) throw new Error("Erro 404");
            dadosOriginal = await r.json();
            
            if (!dadosOriginal || dadosOriginal.length === 0) {
                document.getElementById('lista').innerHTML = `<div class="col-12 text-center py-5"><div class="alert alert-warning d-inline-block">Base de dados vazia. Execute o robô.</div></div>`;
                return;
            }
            filtrar();
        } catch (e) {
            document.getElementById('lista').innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="alert alert-danger d-inline-block shadow-sm">
                        <i class="fas fa-exclamation-circle me-2"></i> Falha ao ler <b>dados.json</b>.
                    </div>
                </div>`;
        }
    }

    function renderizar(lista) {
        const container = document.getElementById('lista');
        
        if (lista.length === 0) {
            container.innerHTML = `<div class="col-12 text-center text-muted py-5 opacity-50">
                <i class="fas fa-search fa-3x mb-3"></i>
                <h4>Nenhum resultado encontrado.</h4>
                <p>Tente ajustar os filtros ou limpar a pesquisa.</p>
            </div>`;
            return;
        }

        let totalVolume = 0, tHml = 0, tFrc = 0, tDst = 0;

        const html = lista.map(i => {
            let hml = 0, frc = 0, dst = 0, valorEdital = 0;

            if (i.Itens && Array.isArray(i.Itens)) {
                i.Itens.forEach(it => {
                    valorEdital += parseFloat(it.Total || it.Valor || 0);
                    const st = (it.Status || "").toUpperCase();
                    if (st.includes("FRACASSADO")) frc++;
                    else if (st.includes("DESERTO")) dst++;
                    else hml++;
                });
            } else if (i.Resumo) {
                // Fallback se Resumo existir
                hml = i.Resumo.Homologados;
                frc = i.Resumo.Fracassados;
                dst = i.Resumo.Desertos;
            }

            totalVolume += valorEdital;
            tHml += hml; tFrc += frc; tDst += dst;

            const totalItens = hml + frc + dst;
            const percHml = totalItens > 0 ? (hml / totalItens) * 100 : 0;

            return `
            <div class="col-md-6 col-lg-4">
                <div class="res-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-light text-dark border px-2 py-1"><i class="far fa-calendar-alt me-1"></i> ${i.DataResult ? i.DataResult.split('T')[0] : '---'}</span>
                        <div class="label-small text-end">UASG: ${i.UASG}</div>
                    </div>
                    
                    <h6 class="fw-bold text-primary mb-1 text-truncate" title="${i.Orgao}">${i.Orgao}</h6>
                    <p class="small text-muted mb-3"><i class="fas fa-map-marker-alt me-1"></i> ${i.Municipio || 'N/I'} - ${i.UF || ''} <span class="mx-1">|</span> Edital: <b>${i.Edital}</b></p>

                    <div class="d-flex justify-content-between align-items-end mb-1">
                        <span class="label-small">Aproveitamento</span>
                        <span class="fw-bold small ${percHml === 100 ? 'text-success' : 'text-muted'}">${Math.round(percHml)}%</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-hml" style="width: ${percHml}%"></div>
                    </div>

                    <div class="p-3 bg-light rounded-3 mb-3 border border-light">
                        <div class="label-small mb-1">Fornecedor Vencedor</div>
                        <div class="fw-bold text-truncate text-dark">${i.Fornecedor}</div>
                        <div class="text-muted small font-monospace">${i.CNPJ}</div>
                    </div>

                    <div class="mt-auto d-flex justify-content-between align-items-center pt-3 border-top">
                        <div class="valor-total">R$ ${valorEdital.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                        <button class="btn btn-outline-primary btn-sm rounded-pill px-4 fw-bold" onclick="verDetalhes('${i.Licitacao}', '${i.CNPJ}')">
                            Detalhes
                        </button>
                    </div>
                </div>
            </div>`;
        }).join('');

        container.innerHTML = html;
        document.getElementById('dash-valor-total').innerText = totalVolume.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
        document.getElementById('stat-hml').innerText = tHml;
        document.getElementById('stat-frc').innerText = tFrc;
        document.getElementById('stat-dst').innerText = tDst;
        document.getElementById('stat-qtd').innerText = lista.length;
        document.getElementById('contador').innerText = `${lista.length} Registros`;
    }

    function debounceFiltrar() {
        clearTimeout(timeoutBusca);
        timeoutBusca = setTimeout(filtrar, 300);
    }

    function filtrar() {
        const q = {
            u: document.getElementById('fUasg').value.trim(),
            e: document.getElementById('fEdital').value.trim(),
            uf: document.getElementById('fUF').value.toUpperCase(),
            m: document.getElementById('fMuni').value.toLowerCase(),
            f: document.getElementById('fForn').value.toLowerCase(),
            di: document.getElementById('fDataIni').value,
            df: document.getElementById('fDataFim').value
        };

        const res = dadosOriginal.filter(i => {
            const data = i.DataResult ? i.DataResult.split('T')[0] : "";
            const matchData = (!q.di || data >= q.di) && (!q.df || data <= q.df);
            
            const txtMuni = (i.Municipio || "").toLowerCase();
            const txtForn = (i.Fornecedor || "").toLowerCase();
            const txtUasg = String(i.UASG || "");
            const txtEdital = String(i.Edital || "");
            
            return (!q.u || txtUasg.includes(q.u)) &&
                   (!q.e || txtEdital.includes(q.e)) &&
                   (!q.uf || (i.UF || "") === q.uf) &&
                   (!q.m || txtMuni.includes(q.m)) &&
                   (!q.f || txtForn.includes(q.f) || String(i.CNPJ).includes(q.f)) &&
                   matchData;
        });
        renderizar(res);
    }

    function verDetalhes(idL, cnpj) {
        const i = dadosOriginal.find(x => x.Licitacao === idL && x.CNPJ === cnpj);
        if(!i) return;

        document.getElementById('infoLicitacao').innerHTML = `
            <div class="row">
                <div class="col-md-8">
                    <h5 class="fw-bold text-primary mb-1">${i.Orgao}</h5>
                    <p class="text-muted small mb-0">UASG: ${i.UASG} | Edital: ${i.Edital}</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="fw-bold">${i.Fornecedor}</div>
                    <div class="small text-muted">${i.CNPJ}</div>
                </div>
            </div>`;
        
        document.getElementById('corpoModal').innerHTML = (i.Itens || []).map(it => `
            <tr>
                <td class="ps-4 fw-bold text-muted text-center">${it.Item}</td>
                <td class="small"><div class="text-wrap" style="max-width: 400px;">${it.Desc}</div></td>
                <td class="text-center">${it.Qtd || '--'}</td>
                <td class="text-nowrap">R$ ${(it.Unitario || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td class="pe-4 text-end fw-bold text-success text-nowrap">R$ ${(it.Total || it.Valor || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>`).join('');
        
        new bootstrap.Modal(document.getElementById('modalItens')).show();
    }
    
    function limpar() {
        document.querySelectorAll('input').forEach(i => i.value = '');
        filtrar();
    }

    carregar();
</script>

</body>
</html>
