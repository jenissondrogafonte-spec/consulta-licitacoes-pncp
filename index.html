<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel PNCP - 90 Dias</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #004494; --success: #198754; --danger: #dc3545; --warning: #ffc107; }
        body { background: #f4f7fa; font-family: 'Plus Jakarta Sans', sans-serif; color: #2d3436; }
        .navbar-custom { background: linear-gradient(135deg, #004494 0%, #003370 100%); color: white; padding: 1.5rem 0; border-radius: 0 0 25px 25px; }
        .dash-card { background: white; border-radius: 18px; padding: 1.5rem; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.04); transition: transform 0.2s; }
        .dash-card:hover { transform: translateY(-3px); }
        .filter-box { background: white; border-radius: 20px; padding: 25px; margin-top: -40px; box-shadow: 0 15px 35px rgba(0,0,0,0.08); }
        .res-card { background: white; border-radius: 20px; border: 1px solid rgba(0,0,0,0.04); transition: all 0.3s; height: 100%; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .res-card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); border-color: var(--primary); }
        .res-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: var(--success); }
        .progress { height: 6px; border-radius: 10px; background: #e9ecef; margin: 12px 0; }
        .progress-bar-hml { background: var(--success); }
        .valor-total { font-size: 1.3rem; font-weight: 800; color: var(--success); letter-spacing: -0.5px; }
        .label-small { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; color: #95a5a6; letter-spacing: 0.5px; margin-bottom: 4px; display: block; }
        .form-control { border-radius: 8px; border: 1px solid #dfe6e9; font-size: 0.9rem; padding: 8px 12px; }
        .btn-buscar { background-color: var(--primary); color: white; font-weight: 600; border-radius: 8px; }
        .btn-limpar { background-color: #f1f2f6; color: #636e72; font-weight: 600; border-radius: 8px; }
    </style>
</head>
<body>

<div class="navbar-custom shadow-lg">
    <div class="container-fluid px-5">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2 class="fw-bold mb-0"><i class="fas fa-chart-network me-2"></i>PNCP <span class="fw-light">Analytics</span></h2>
            </div>
            <div class="col-md-6 text-end">
                <div class="d-inline-block text-start me-4">
                    <div class="label-small text-white opacity-75" style="color: white !important;">Volume Filtrado</div>
                    <h4 class="mb-0 fw-bold" id="dash-valor-total">R$ 0,00</h4>
                </div>
                <span class="badge bg-white text-primary rounded-pill px-4 py-2 fw-bold shadow-sm" id="contador">Carregando...</span>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid px-5">
    <div id="erro-box" class="alert alert-danger shadow-sm mt-3 d-none"></div>

    <div class="filter-box mb-5">
        <div class="row g-3 align-items-end">
            <div class="col-md-1"><label class="label-small">UASG</label><input type="text" id="fUasg" class="form-control" oninput="debounceFiltrar()"></div>
            <div class="col-md-1"><label class="label-small">Edital</label><input type="text" id="fEdital" class="form-control" oninput="debounceFiltrar()"></div>
            <div class="col-md-1"><label class="label-small">UF</label><input type="text" id="fUF" class="form-control" maxlength="2" oninput="debounceFiltrar()"></div>
            <div class="col-md-2"><label class="label-small">Município</label><input type="text" id="fMuni" class="form-control" oninput="debounceFiltrar()"></div>
            <div class="col-md-3"><label class="label-small">Fornecedor / CNPJ</label><input type="text" id="fForn" class="form-control" oninput="debounceFiltrar()"></div>
            <div class="col-md-1"><label class="label-small">Início (Res)</label><input type="date" id="fDataIni" class="form-control" onchange="filtrar()"></div>
            <div class="col-md-1"><label class="label-small">Fim (Res)</label><input type="date" id="fDataFim" class="form-control" onchange="filtrar()"></div>
            <div class="col-md-2">
                <div class="d-flex gap-2">
                    <button class="btn btn-buscar w-100" onclick="filtrar()"><i class="fas fa-search me-1"></i></button>
                    <button class="btn btn-limpar w-50" onclick="limpar()"><i class="fas fa-eraser"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-3"><div class="dash-card text-center"><div class="label-small text-success">Homologados</div><h3 class="fw-bold text-success" id="stat-hml">0</h3></div></div>
        <div class="col-md-3"><div class="dash-card text-center"><div class="label-small text-danger">Fracassados</div><h3 class="fw-bold text-danger" id="stat-frc">0</h3></div></div>
        <div class="col-md-3"><div class="dash-card text-center"><div class="label-small text-warning">Desertos</div><h3 class="fw-bold text-warning" id="stat-dst">0</h3></div></div>
        <div class="col-md-3"><div class="dash-card text-center" style="background: #004494; color: white;"><div class="label-small text-white opacity-75">Contratos</div><h3 class="fw-bold" id="stat-qtd">0</h3></div></div>
    </div>

    <div id="lista" class="row g-4 mb-5">
        <div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div></div>
    </div>
</div>

<div class="modal fade" id="modalItens" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 25px; overflow: hidden;">
            <div class="modal-header bg-primary text-white p-4">
                <h5 class="modal-title fw-bold">Detalhes do Processo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="infoLicitacao" class="px-4 py-3 bg-light border-bottom"></div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-dark text-white">
                            <tr><th class="ps-4 py-3">Item</th><th class="py-3">Descrição</th><th class="py-3">Qtd</th><th class="py-3">Unitário</th><th class="py-3 pe-4 text-end">Total</th></tr>
                        </thead>
                        <tbody id="corpoModal"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer bg-light" id="modalFooter">
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let dadosOriginal = [];
    let timeoutBusca = null;

    async function carregar() {
        const errorBox = document.getElementById('erro-box');
        
        try {
            // Força no-cache com timestamp
            const response = await fetch('dados.json?v=' + Date.now());
            
            // Verifica Erros HTTP (ex: 404)
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status} - Arquivo não encontrado.`);
            }

            const text = await response.text();
            
            // Verifica se está vazio
            if (!text || text.trim() === "") {
                throw new Error("O arquivo dados.json está vazio. O robô ainda deve estar a rodar.");
            }

            try {
                dadosOriginal = JSON.parse(text);
            } catch (jsonError) {
                throw new Error("O arquivo dados.json está corrompido (Erro de Sintaxe JSON).");
            }

            if (!Array.isArray(dadosOriginal)) {
                // Se não for lista, tenta converter ou alerta erro
                dadosOriginal = [];
                throw new Error("O formato do JSON não é uma lista válida.");
            }
            
            // Se chegou aqui, sucesso
            errorBox.classList.add('d-none');
            filtrar();

        } catch (e) {
            console.error(e);
            errorBox.classList.remove('d-none');
            errorBox.innerHTML = `
                <h5 class="fw-bold"><i class="fas fa-exclamation-triangle me-2"></i> Falha ao carregar dados!</h5>
                <p class="mb-0">${e.message}</p>
                <small class="mt-2 d-block">Dica: Verifique se o GitHub Actions "Coletar" já terminou (ficou verde).</small>
            `;
            document.getElementById('lista').innerHTML = "";
            document.getElementById('contador').innerText = "Erro";
        }
    }

    function renderizar(lista) {
        const container = document.getElementById('lista');
        if (lista.length === 0) {
            container.innerHTML = `<div class="col-12 text-center text-muted py-5"><h4>Nenhum resultado encontrado.</h4></div>`;
            return;
        }

        let totalVolume = 0, tHml = 0, tFrc = 0, tDst = 0;
