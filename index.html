<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel PNCP - Resultados por Pregão</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f0f2f5; font-family: 'Inter', sans-serif; }
        .header-top { background: #004494; color: white; padding: 20px; }
        .res-card { background: white; border-radius: 12px; border-top: 6px solid #198754; transition: 0.3s; height: 100%; }
        .res-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .stats-box { font-size: 0.7rem; font-weight: bold; padding: 4px; border-radius: 4px; text-align: center; color: white; }
        .bg-hml { background: #198754; } .bg-frc { background: #dc3545; } .bg-dst { background: #ffc107; color: #000; }
        .form-label { font-size: 0.75rem; margin-bottom: 2px; }
    </style>
</head>
<body>

<div class="header-top shadow mb-4">
    <div class="container-fluid d-flex justify-content-between align-items-center">
        <h4 class="mb-0 fw-bold"><i class="fas fa-gavel me-2"></i> Resultados Pregão Eletrônico</h4>
        <span class="badge bg-white text-primary px-3 py-2" id="contador">Carregando...</span>
    </div>
</div>

<div class="container-fluid px-4">
    <div class="card p-3 shadow-sm mb-4 border-0">
        <div class="row g-2">
            <div class="col-md-1"><label class="form-label fw-bold">UASG</label><input type="text" id="fUasg" class="form-control form-control-sm"></div>
            <div class="col-md-1"><label class="form-label fw-bold">Edital</label><input type="text" id="fEdital" class="form-control form-control-sm"></div>
            <div class="col-md-1"><label class="form-label fw-bold">UF</label><input type="text" id="fUF" class="form-control form-control-sm"></div>
            <div class="col-md-2"><label class="form-label fw-bold">Município</label><input type="text" id="fMuni" class="form-control form-control-sm"></div>
            <div class="col-md-2"><label class="form-label fw-bold">Fornecedor / CNPJ</label><input type="text" id="fForn" class="form-control form-control-sm"></div>
            <div class="col-md-1.5"><label class="form-label fw-bold">Data Inicial</label><input type="date" id="fDataIni" class="form-control form-control-sm"></div>
            <div class="col-md-1.5"><label class="form-label fw-bold">Data Final</label><input type="date" id="fDataFim" class="form-control form-control-sm"></div>
            <div class="col-md-2 d-flex align-items-end gap-1">
                <button class="btn btn-primary btn-sm w-100" onclick="filtrar()">Pesquisar</button>
                <button class="btn btn-light btn-sm w-100 border" onclick="limpar()">Limpar</button>
            </div>
        </div>
    </div>

    <div id="lista" class="row g-3"></div>
</div>

<div class="modal fade" id="modalItens" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content shadow border-0">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Itens do Fornecedor no Edital</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div id="infoLicitacao" class="p-4 bg-light border-bottom"></div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-dark">
                            <tr><th class="ps-4">Item</th><th>Descrição</th><th>Qtd</th><th>Unitário</th><th>Total</th></tr>
                        </thead>
                        <tbody id="corpoModal"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let dadosOriginal = [];

    async function carregar() {
        try {
            const r = await fetch('dados.json?v=' + Date.now());
            dadosOriginal = await r.json();
            document.getElementById('contador').innerText = `${dadosOriginal.length} Editais/Vencedores`;
            renderizar(dadosOriginal);
        } catch (e) { 
            document.getElementById('lista').innerHTML = `<div class="col-12 text-center py-5"><h5>Erro ao carregar dados.json</h5></div>`;
        }
    }

    function renderizar(lista) {
        const container = document.getElementById('lista');
        container.innerHTML = lista.map(i => {
            const res = i.Resumo || {Homologados: 0, Fracassados: 0, Desertos: 0};
            return `
            <div class="col-md-4">
                <div class="card res-card p-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge bg-light text-dark border">${i.DataResult ? i.DataResult.split('T')[0] : '---'}</span>
                        <small class="text-muted fw-bold">UASG: ${i.UASG}</small>
                    </div>
                    <h6 class="fw-bold text-primary text-truncate mb-1" title="${i.Orgao}">${i.Orgao}</h6>
                    <p class="small text-muted mb-2">${i.Municipio || 'N/I'} - ${i.UF || '--'} | Edital: ${i.Edital}</p>
                    
                    <div class="row g-1 mb-3">
                        <div class="col-4"><div class="stats-box bg-hml">HML: ${res.Homologados}</div></div>
                        <div class="col-4"><div class="stats-box bg-frc">FRC: ${res.Fracassados}</div></div>
                        <div class="col-4"><div class="stats-box bg-dst">DST: ${res.Desertos}</div></div>
                    </div>

                    <div class="p-2 border rounded bg-light mb-3">
                        <small class="d-block fw-bold text-truncate">${i.Fornecedor || 'ITEM SEM VENCEDOR'}</small>
                        <small class="text-muted">CNPJ: ${i.CNPJ}</small>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-auto">
                        <span class="fw-bold text-success">R$ ${calcTotal(i.Itens)}</span>
                        <button class="btn btn-sm btn-primary" onclick="verDetalhes('${i.Licitacao}', '${i.CNPJ}')">Detalhes</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function calcTotal(itens) {
        if(!itens) return "0,00";
        const t = itens.reduce((acc, curr) => acc + (parseFloat(curr.Total || curr.Valor) || 0), 0);
        return t.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    }

    function verDetalhes(idL, cnpj) {
        const i = dadosOriginal.find(x => x.Licitacao === idL && x.CNPJ === cnpj);
        if(!i) return;
        document.getElementById('infoLicitacao').innerHTML = `<h6>${i.Orgao}</h6><p class="small mb-0"><b>Edital:</b> ${i.Edital} | <b>Empresa:</b> ${i.Fornecedor}</p>`;
        document.getElementById('corpoModal').innerHTML = (i.Itens || []).map(it => `
            <tr>
                <td class="ps-4 fw-bold">${it.Item}</td>
                <td class="small">${it.Desc}</td>
                <td>${it.Qtd || '--'}</td>
                <td>R$ ${(it.Unitario || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td class="fw-bold">R$ ${(it.Total || it.Valor || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
            </tr>`).join('');
        new bootstrap.Modal(document.getElementById('modalItens')).show();
    }

    function filtrar() {
        const query = {
            u: document.getElementById('fUasg').value.trim(),
            e: document.getElementById('fEdital').value.trim(),
            uf: document.getElementById('fUF').value.toUpperCase(),
            m: document.getElementById('fMuni').value.toLowerCase(),
            f: document.getElementById('fForn').value.toLowerCase(),
            di: document.getElementById('fDataIni').value,
            df: document.getElementById('fDataFim').value
        };
        const filtrados = dadosOriginal.filter(i => {
            const data = i.DataResult ? i.DataResult.split('T')[0] : "";
            const matchU = !query.u || i.UASG.includes(query.u);
            const matchE = !query.e || i.Edital.includes(query.e);
            const matchUF = !query.uf || i.UF === query.uf;
            const matchM = !query.m || (i.Municipio || "").toLowerCase().includes(query.m);
            const matchF = !query.f || (i.Fornecedor || "").toLowerCase().includes(query.f) || i.CNPJ.includes(query.f);
            
            let matchD = true;
            if (query.di && query.df) matchD = data >= query.di && data <= query.df;
            else if (query.di) matchD = data >= query.di;
            else if (query.df) matchD = data <= query.df;

            return matchU && matchE && matchUF && matchM && matchF && matchD;
        });
        renderizar(filtrados);
    }

    function limpar() {
        document.querySelectorAll('input').forEach(i => i.value = '');
        renderizar(dadosOriginal);
    }

    carregar();
</script>
</body>
</html>
